CREATE DATABASE UniversidadeLevi;
GO
USE UniversidadeLevi;
GO
CREATE TABLE ALUNOS
(
    MATRICULA INT NOT NULL IDENTITY
        CONSTRAINT PK_ALUNO PRIMARY KEY,
    NOME VARCHAR(50) NOT NULL
);
GO

CREATE TABLE CURSOS
(
    CURSO CHAR(3) NOT NULL
        CONSTRAINT PK_CURSO PRIMARY KEY,
    NOME VARCHAR(50) NOT NULL
);
GO

CREATE TABLE PROFESSOR
(
    PROFESSOR INT IDENTITY NOT NULL
        CONSTRAINT PK_PROFESSOR PRIMARY KEY,
    NOME VARCHAR(50) NOT NULL
);
GO

CREATE TABLE MATERIAS
(
    SIGLA CHAR(3) NOT NULL,
    NOME VARCHAR(50) NOT NULL,
    CARGAHORARIA INT NOT NULL,
    CURSO CHAR(3) NOT NULL,
    PROFESSOR INT
        CONSTRAINT PK_MATERIA
        PRIMARY KEY(
                        SIGLA
                   )
        CONSTRAINT FK_CURSO
        FOREIGN KEY (CURSO) REFERENCES CURSOS (CURSO),
    CONSTRAINT FK_PROFESSOR
        FOREIGN KEY (PROFESSOR)
        REFERENCES PROFESSOR (PROFESSOR)
);
GO

INSERT ALUNOS
(
    NOME
)
VALUES
('Gabriel');
GO

INSERT CURSOS
(
    CURSO,
    NOME
)

VALUES ('ENG', 'ENGENHARIA')
GO

INSERT PROFESSOR
(
    NOME
)

VALUES ('DORNEL'), ('WALTER');
GO

INSERT MATERIAS
(
    SIGLA,
    NOME,
    CARGAHORARIA,
    CURSO,
    PROFESSOR
)

VALUES ('BDA', 'BANCO DE DADOS', 144, 'ENG',1), ('PRG', 'PROGRAMAÇÃO', 144, 'ENG', 2);

CREATE TABLE MATRICULA
	(
		MATRICULA INT,
		CURSO CHAR(3),
		MATERIA CHAR(3),
		PROFESSOR INT,
		PERLETIVO INT,
		N1 FLOAT,
		N2 FLOAT,
		N3 FLOAT,
		N4 FLOAT,
		TOTALPONTOS FLOAT,
		MEDIA FLOAT,
		F1 INT,
		F2 INT,
		F3 INT,
		F4 INT,
		TOTALFALTAS INT,
		PERCFREQ FLOAT,
		RESULTADO VARCHAR(20)
			CONSTRAINT PK_MATRICULA
			PRIMARY KEY (
							MATRICULA,
							CURSO,
							MATERIA,
							PROFESSOR,
							PERLETIVO
						),
		CONSTRAINT FK_ALUNOS_MATRICULA
			FOREIGN KEY (MATRICULA)
			REFERENCES ALUNOS (MATRICULA),
		CONSTRAINT FK_CURSOS_MATRICULA
			FOREIGN KEY (CURSO)
			REFERENCES CURSOS (CURSO),
		CONSTRAINT FK_MATERIAS FOREIGN KEY (MATERIA) REFERENCES MATERIAS (SIGLA),
		CONSTRAINT FK_PROFESSOR_MATRICULA
			FOREIGN KEY (PROFESSOR)
			REFERENCES PROFESSOR (PROFESSOR)
	);
GO
ALTER TABLE MATRICULA ADD MEDIAFINAL FLOAT;
GO
ALTER TABLE MATRICULA ADD NOTAEXAME FLOAT;
GO


INSERT MATRICULA (MATRICULA, CURSO, MATERIA,PROFESSOR,PERLETIVO)
VALUES (1,'ENG','BDA',1,2025)
GO



-- PROCEDURE



CREATE OR ALTER PROCEDURE sp_CadastraNotas
	(
		@MATRICULA INT,
		@CURSO CHAR(3),
		@MATERIA CHAR(3),
		@PERLETIVO CHAR(4),
		@NOTA FLOAT,
		@FALTA INT,
		@BIMESTRE INT
	)
	AS
BEGIN

		IF @BIMESTRE = 1
		    BEGIN

                UPDATE MATRICULA
                SET N1 = @NOTA,
                    F1 = @FALTA,
                    TOTALPONTOS = @NOTA,
                    TOTALFALTAS = @FALTA,
                    MEDIA = @NOTA
                WHERE MATRICULA = @MATRICULA
                    AND CURSO = @CURSO
                    AND MATERIA = @MATERIA
                    AND PERLETIVO = @PERLETIVO;
		    END

        ELSE 
        
        IF @BIMESTRE = 2
            BEGIN

                UPDATE MATRICULA
                SET N2 = @NOTA,
                    F2 = @FALTA,
                    TOTALPONTOS = @NOTA + N1,
                    TOTALFALTAS = @FALTA + F1,
                    MEDIA = (@NOTA + N1) / 2
                WHERE MATRICULA = @MATRICULA
                    AND CURSO = @CURSO
                    AND MATERIA = @MATERIA
                    AND PERLETIVO = @PERLETIVO;
            END

        ELSE 
        
        IF @BIMESTRE = 3
            BEGIN

                UPDATE MATRICULA
                SET N3 = @NOTA,
                    F3 = @FALTA,
                    TOTALPONTOS = @NOTA + N1 + N2,
                    TOTALFALTAS = @FALTA + F1 + F2,
                    MEDIA = (@NOTA + N1 + N2) / 3
                WHERE MATRICULA = @MATRICULA
                    AND CURSO = @CURSO
                    AND MATERIA = @MATERIA
                    AND PERLETIVO = @PERLETIVO;
            END

        ELSE 
        
        IF @BIMESTRE = 4
            BEGIN

                DECLARE @RESULTADO VARCHAR(50),
                        @FREQUENCIA FLOAT,
                        @MEDIAFINAL FLOAT,
                        @CARGAHORA INT,
                        @TOTALFALTAS INT,
                        @MEDIA FLOAT
                
                SET @CARGAHORA = (
                    SELECT CARGAHORARIA FROM MATERIAS 
                    WHERE       SIGLA = @MATERIA
                            AND CURSO = @CURSO)

                SELECT @TOTALFALTAS = TOTALFALTAS FROM MATRICULA
                 WHERE MATRICULA = @MATRICULA
                    AND CURSO = @CURSO
                    AND MATERIA = @MATERIA
                    AND PERLETIVO = @PERLETIVO;

                UPDATE MATRICULA
                SET N4 = @NOTA,
                    F4 = @FALTA,
                    TOTALPONTOS = @NOTA + N1 + N2 + N3,
                    TOTALFALTAS = @FALTA + F1 + F2 + F3,
                    MEDIA = (@NOTA + N1 + N2 + N3) / 4,
                    PERCFREQ = (((@FALTA + F1 + F2 + F3) * 100.0) / (@CARGAHORA/2) -100) * (-1),
                RESULTADO = CASE WHEN (N1 + N2 + N3 + @NOTA) /4 >= 7 THEN 'APROVADO'
                         WHEN (N1 + N2 + N3 + @NOTA) /4 >= 3 AND (N1 + N2 + N3 + @NOTA) /4 < 7 THEN 'EXAME'
                         WHEN (N1 + N2 + N3 + @NOTA) /4 < 3 THEN 'REPROVADO'
                         END
                UPDATE MATRICULA
                SET RESULTADO = 
                    CASE 
                        WHEN PERCFREQ < 75 THEN 'REPROVADO POR FALTA'
                        WHEN MEDIA >= 7 THEN 'APROVADO'
                        WHEN MEDIA >= 3 AND MEDIA < 7 THEN 'EXAME'
                        ELSE 'REPROVADO'
                    END

                WHERE MATRICULA = @MATRICULA
                    AND CURSO = @CURSO
                    AND MATERIA = @MATERIA
                    AND PERLETIVO = @PERLETIVO;

            END

        IF @BIMESTRE = 5
            BEGIN

        UPDATE MATRICULA
                SET NOTAEXAME = @NOTA,
                MEDIA = (@MEDIA + NOTAEXAME) /2
            

		SELECT * FROM MATRICULA	WHERE MATRICULA = @MATRICULA
END
GO

EXEC sp_CadastraNotas @MATRICULA = 1,      -- int
                      @CURSO = 'ENG',      -- char(3)
                      @MATERIA = 'BDA',    -- char(3)
                      @PERLETIVO = '2025', -- char(4)
                      @NOTA = 7.0,         -- float
                      @FALTA = 2,
                      @BIMESTRE = 1      -- int
                      
INSERT MATRICULA (MATRICULA, CURSO, MATERIA,PROFESSOR,PERLETIVO)
VALUES (2,'ENG','BDA',2,2025)
GO

SELECT * FROM MATRICULA

INSERT ALUNOS VALUES ('Levi');

EXEC sp_CadastraNotas @MATRICULA = 2,      -- int
                      @CURSO = 'ENG',      -- char(3)
                      @MATERIA = 'BDA',    -- char(3)
                      @PERLETIVO = '2025', -- char(4)
                      @NOTA = 9.0,         -- float
                      @FALTA = 2,
                      @BIMESTRE = 1      -- int

SELECT * FROM MATRICULA

INSERT CURSOS VALUES ('SIS', 'SISTEMAS')

INSERT MATERIAS VALUES ('APS', 'ANALISE E PROJETO DE SISTEMAS', 144, 'SIS', 2)

INSERT PROFESSOR VALUES ('SERGIO')

INSERT MATRICULA (MATRICULA, CURSO, MATERIA,PROFESSOR,PERLETIVO)
VALUES (2,'SIS','APS',3,2025)

SELECT * FROM MATRICULA

EXEC sp_CadastraNotas @MATRICULA = 2,      -- int
                      @CURSO = 'ENG',      -- char(3)
                      @MATERIA = 'BDA',    -- char(3)
                      @PERLETIVO = '2025', -- char(4)
                      @NOTA = 9.0,         -- float
                      @FALTA = 2,
                      @BIMESTRE = 4      -- int

INSERT MATERIAS VALUES ('JAV', 'JAVA', 144, 'SIS', 3)

INSERT MATRICULA VALUES (2, 'SIS', 'JAV', 3, 2025)

EXEC sp_CadastraNotas @MATRICULA = 2,      -- int
                      @CURSO = 'ENG',      -- char(3)
                      @MATERIA = 'BDA',    -- char(3)
                      @PERLETIVO = '2025', -- char(4)
                      @NOTA = 0.0,         -- float
                      @FALTA = 3,
                      @BIMESTRE = 4      -- int

SELECT * FROM ALUNOS

SELECT * FROM MATERIAS
